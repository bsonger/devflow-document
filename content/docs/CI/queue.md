# ⏱️ CI 队列与并发控制

CI 队列用于在高并发构建场景下实现 **有序、可控与公平** 的资源调度，避免构建雪崩与集群资源被打满。

## 🎯 目标

- 平衡吞吐与稳定性（避免抢占导致抖动）
- 保证关键流水线优先级（生产修复 > 日常构建）
- 控制资源成本（限制并发与峰值）

## 🧩 常见策略

| 策略 | 说明 | 适用场景 |
|------|------|---------|
| FIFO | 先进先出 | 小规模、无强优先级需求 |
| Priority | 按优先级出队 | 生产修复、紧急发布 |
| Per-Repo | 每仓库限流 | 多团队共享集群 |
| Per-Cluster | 全局并发上限 | 资源紧张或成本敏感 |

## 🔧 Tekton 实现要点（示例）

- 使用 `PipelineRun` 并发限制（配合 namespace 配额）
- 结合 `PriorityClass` 区分任务优先级
- 用 `LimitRange` / `ResourceQuota` 控制单个流水线资源
- 对重任务单独拆分执行池（如镜像构建专用节点）

## 📈 关键指标

- 队列长度（Queue Depth）
- 平均等待时间（Queue Wait Time）
- 吞吐量（Runs / Hour）
- 失败率（Failure Rate）

## ✅ 推荐做法

- 默认 FIFO，遇到生产紧急任务再引入 Priority
- 对大型构建设置并发上限与资源配额
- 对高频仓库设置每仓库限流
